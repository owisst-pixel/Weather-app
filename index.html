<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#1e3a8a">
    <title>NATGAS Pro Tracker</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%);
            min-height: 100vh;
        }
        .app { max-width: 100%; min-height: 100vh; background: white; }
        .header {
            background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%);
            color: white; padding: 20px; text-align: center;
        }
        .header h1 { font-size: 20px; margin-bottom: 5px; }
        .last-update {
            font-size: 11px; opacity: 0.9; margin-top: 5px;
            background: rgba(255,255,255,0.2); padding: 5px 10px;
            border-radius: 12px; display: inline-block;
        }
        .temp-toggle { display: flex; justify-content: center; gap: 10px; margin-top: 10px; }
        .temp-btn {
            padding: 8px 24px; border: 2px solid white; background: transparent;
            color: white; border-radius: 20px; font-weight: 600; cursor: pointer;
            transition: all 0.3s; font-size: 14px;
        }
        .temp-btn.active { background: white; color: #1e3a8a; }
        .controls { padding: 15px; background: #f8f9fa; }
        select, button {
            width: 100%; padding: 14px; margin-bottom: 10px;
            border: 2px solid #ddd; border-radius: 10px; font-size: 16px; background: white;
        }
        button { border: none; color: white; font-weight: 600; cursor: pointer; }
        button:active { transform: scale(0.98); }
        .btn-primary { background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%); }
        .status {
            padding: 12px; text-align: center; font-weight: 600;
            background: #e8f5e9; color: #2e7d32;
        }
        .status.loading { background: #fff3e0; color: #e65100; }
        .content { padding: 15px; }
        
        /* Signal Card */
        .signal-card {
            background: white;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border-left: 5px solid #666;
        }
        .signal-card.bullish { border-left-color: #10b981; }
        .signal-card.bearish { border-left-color: #ef4444; }
        .signal-card.neutral { border-left-color: #f59e0b; }
        
        .signal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .signal-title { font-size: 16px; font-weight: 700; color: #1e3a8a; }
        .signal-badge {
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 700;
            text-transform: uppercase;
        }
        .signal-badge.bullish { background: #dcfce7; color: #166534; }
        .signal-badge.bearish { background: #fee2e2; color: #991b1b; }
        .signal-badge.neutral { background: #fef3c7; color: #92400e; }
        
        .signal-details {
            font-size: 13px;
            line-height: 1.6;
            color: #666;
            margin-top: 10px;
        }
        .signal-metric {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #f0f0f0;
        }
        .signal-metric:last-child { border-bottom: none; }
        .metric-label { color: #666; font-size: 13px; }
        .metric-value { font-weight: 700; font-size: 14px; }
        .metric-value.positive { color: #10b981; }
        .metric-value.negative { color: #ef4444; }
        
        /* Comparison Card */
        .comparison-card {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
        }
        .comparison-header {
            font-weight: 700;
            font-size: 15px;
            margin-bottom: 10px;
            color: #1e3a8a;
        }
        .comparison-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            font-size: 13px;
        }
        .comparison-change {
            font-weight: 700;
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 12px;
        }
        .comparison-change.up {
            background: #fee2e2;
            color: #991b1b;
        }
        .comparison-change.down {
            background: #dcfce7;
            color: #166534;
        }
        
        .market-data {
            background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%);
            color: white; border-radius: 12px; padding: 15px; margin-bottom: 15px;
        }
        .market-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-top: 10px; }
        .market-item {
            background: rgba(255,255,255,0.15); padding: 12px;
            border-radius: 8px; text-align: center;
        }
        .market-label { font-size: 11px; opacity: 0.9; margin-bottom: 5px; }
        .market-value { font-size: 20px; font-weight: 700; }
        .market-date { font-size: 9px; opacity: 0.8; margin-top: 3px; }
        
        .forecast-card {
            background: #f8f9fa; border-radius: 10px; padding: 12px;
            margin-bottom: 10px; border-left: 4px solid #3b82f6;
        }
        .city-name { font-weight: 700; color: #1e3a8a; margin-bottom: 5px; }
        .temp-display { font-size: 20px; font-weight: 700; color: #3b82f6; margin: 5px 0; }
        .hdd-cdd-inline { display: flex; gap: 8px; margin-top: 8px; font-size: 12px; }
        .hdd-inline {
            background: #dbeafe; color: #1e40af; padding: 6px 10px;
            border-radius: 6px; flex: 1; text-align: center; font-weight: 600;
        }
        .cdd-inline {
            background: #fee2e2; color: #991b1b; padding: 6px 10px;
            border-radius: 6px; flex: 1; text-align: center; font-weight: 600;
        }
        .source {
            text-align: center; font-size: 11px; color: #666;
            padding: 15px; border-top: 1px solid #e0e0e0; margin-top: 20px;
        }
        .source a { color: #3b82f6; text-decoration: none; }
    </style>
</head>
<body>
    <div class="app">
        <div class="header">
            <h1>üî• NATGAS Pro Tracker</h1>
            <p style="font-size: 12px; opacity: 0.9;">Trading Signals ‚Ä¢ HDD/CDD ‚Ä¢ Market Data</p>
            <div class="last-update" id="lastUpdate">Last update: Never</div>
            <div class="temp-toggle">
                <button class="temp-btn active" id="btnF">¬∞F</button>
                <button class="temp-btn" id="btnC">¬∞C</button>
            </div>
        </div>
        
        <div class="controls">
            <select id="city">
                <option value="All">üìç All Cities (Compare)</option>
                <option value="Houston">Houston, TX (Henry Hub)</option>
                <option value="New York">New York, NY</option>
                <option value="Chicago">Chicago, IL</option>
                <option value="Boston">Boston, MA</option>
                <option value="Los Angeles">Los Angeles, CA</option>
            </select>
            <button class="btn-primary" id="updateBtn">üîÑ Update Data</button>
        </div>
        
        <div id="status" class="status">Click "Update Data" to start</div>
        
        <div class="content">
            <!-- Trading Signal -->
            <div id="tradingSignal"></div>
            
            <!-- Comparison with Previous -->
            <div id="comparisonCard"></div>
            
            <!-- Market Data -->
            <div class="market-data">
                <h3 style="margin-bottom: 10px;">üìä Market Data (Latest)</h3>
                <div class="market-grid">
                    <div class="market-item">
                        <div class="market-label">Gas Storage</div>
                        <div class="market-value" id="gasStorage">2,450</div>
                        <div class="market-date" id="storageDate">Bcf</div>
                    </div>
                    <div class="market-item">
                        <div class="market-label">Weekly Change</div>
                        <div class="market-value" id="storageChange">-45</div>
                        <div class="market-date">Bcf</div>
                    </div>
                    <div class="market-item">
                        <div class="market-label">Active Gas Rigs</div>
                        <div class="market-value" id="rigCount">127</div>
                        <div class="market-date" id="rigDate">Latest</div>
                    </div>
                    <div class="market-item">
                        <div class="market-label">Total HDD (10d)</div>
                        <div class="market-value" id="totalHDD">---</div>
                        <div class="market-date">All Cities</div>
                    </div>
                </div>
            </div>
            
            <!-- Forecasts -->
            <div id="forecastContent">
                <div style="text-align: center; padding: 40px 20px; color: #999;">
                    Select a city and click "Update Data"
                </div>
            </div>
        </div>
        
        <div class="source">
            <strong>Live Data Sources:</strong><br>
            Weather: <a href="https://open-meteo.com">Open-Meteo API</a><br>
            Storage: <a href="https://www.eia.gov/naturalgas/weekly/">EIA Weekly (Updated Thu 10:30 ET)</a><br>
            Rigs: <a href="https://rigcount.bakerhughes.com">Baker Hughes (Updated Fri)</a>
        </div>
    </div>

    <script>
        let tempUnit = 'F';
        let currentData = null;
        let previousData = null;
        
        const cities = {
            "Houston": [29.7604, -95.3698],
            "New York": [40.7128, -74.0060],
            "Chicago": [41.8781, -87.6298],
            "Boston": [42.3601, -71.0589],
            "Los Angeles": [34.0522, -118.2437]
        };
        
        const weatherCodes = {
            0: "Clear", 1: "Clear", 2: "Partly Cloudy", 3: "Cloudy",
            61: "Rain", 63: "Rain", 65: "Heavy Rain",
            71: "Snow", 73: "Snow", 75: "Heavy Snow",
            95: "Thunderstorm"
        };
        
        // Load previous data from localStorage
        function loadPreviousData() {
            const saved = localStorage.getItem('natgas_previous_data');
            if (saved) {
                try {
                    previousData = JSON.parse(saved);
                } catch (e) {
                    previousData = null;
                }
            }
        }
        
        function savePreviousData(data) {
            previousData = {
                timestamp: new Date().toISOString(),
                data: data,
                totals: calculateTotals(data)
            };
            localStorage.setItem('natgas_previous_data', JSON.stringify(previousData));
        }
        
        function calculateTotals(data) {
            let totalHDD = 0, totalCDD = 0, avgTemp = 0, count = 0;
            
            for (const [cityName, daily] of Object.entries(data)) {
                for (let i = 0; i < 10; i++) {
                    const avg = (daily.temperature_2m_min[i] + daily.temperature_2m_max[i]) / 2;
                    totalHDD += calculateHDD(avg);
                    totalCDD += calculateCDD(avg);
                    avgTemp += avg;
                    count++;
                }
            }
            
            return {
                totalHDD,
                totalCDD,
                avgTemp: avgTemp / count
            };
        }
        
        // Temperature buttons
        document.getElementById('btnF').addEventListener('click', function() {
            tempUnit = 'F';
            document.getElementById('btnF').classList.add('active');
            document.getElementById('btnC').classList.remove('active');
            if (currentData) displayData(currentData);
        });
        
        document.getElementById('btnC').addEventListener('click', function() {
            tempUnit = 'C';
            document.getElementById('btnC').classList.add('active');
            document.getElementById('btnF').classList.remove('active');
            if (currentData) displayData(currentData);
        });
        
        // Update button
        document.getElementById('updateBtn').addEventListener('click', fetchData);
        
        function toFahrenheit(c) { return (c * 9/5) + 32; }
        function toCelsius(f) { return (f - 32) * 5/9; }
        function convertTemp(temp) { return tempUnit === 'C' ? toCelsius(temp) : temp; }
        function calculateHDD(avgF) { return Math.max(0, 65 - avgF); }
        function calculateCDD(avgF) { return Math.max(0, avgF - 65); }
        
        function determineTradingSignal(totals, previous) {
            let signal = 'neutral';
            let strength = 0;
            let reasons = [];
            
            const { totalHDD, totalCDD, avgTemp } = totals;
            
            // HDD Analysis (Winter demand)
            if (totalHDD > 400) {
                strength += 2;
                reasons.push(`Strong heating demand (${totalHDD.toFixed(0)} HDD)`);
            } else if (totalHDD > 250) {
                strength += 1;
                reasons.push(`Moderate heating demand (${totalHDD.toFixed(0)} HDD)`);
            }
            
            // CDD Analysis (Summer demand)
            if (totalCDD > 200) {
                strength += 2;
                reasons.push(`Strong cooling demand (${totalCDD.toFixed(0)} CDD)`);
            } else if (totalCDD > 100) {
                strength += 1;
                reasons.push(`Moderate cooling demand (${totalCDD.toFixed(0)} CDD)`);
            }
            
            // Comparison with previous
            if (previous) {
                const hddChange = totalHDD - previous.totalHDD;
                const cddChange = totalCDD - previous.totalCDD;
                
                if (Math.abs(hddChange) > 50) {
                    if (hddChange > 0) {
                        strength += 1;
                        reasons.push(`HDD increased by ${hddChange.toFixed(0)} (colder forecast)`);
                    } else {
                        strength -= 1;
                        reasons.push(`HDD decreased by ${Math.abs(hddChange).toFixed(0)} (warmer forecast)`);
                    }
                }
                
                if (Math.abs(cddChange) > 30) {
                    if (cddChange > 0) {
                        strength += 1;
                        reasons.push(`CDD increased by ${cddChange.toFixed(0)} (hotter forecast)`);
                    } else {
                        strength -= 1;
                        reasons.push(`CDD decreased by ${Math.abs(cddChange).toFixed(0)} (cooler forecast)`);
                    }
                }
            }
            
            // Low demand scenario
            if (totalHDD < 100 && totalCDD < 50) {
                strength -= 2;
                reasons.push('Mild weather - low heating and cooling demand');
            }
            
            // Determine signal
            if (strength >= 2) {
                signal = 'bullish';
            } else if (strength <= -2) {
                signal = 'bearish';
            } else {
                signal = 'neutral';
            }
            
            return {
                signal,
                strength,
                reasons,
                totals
            };
        }
        
        function displayTradingSignal(analysis) {
            const { signal, strength, reasons, totals } = analysis;
            
            const signalEmoji = {
                'bullish': 'üìà',
                'bearish': 'üìâ',
                'neutral': '‚û°Ô∏è'
            };
            
            const signalText = {
                'bullish': 'BULLISH',
                'bearish': 'BEARISH',
                'neutral': 'NEUTRAL'
            };
            
            const html = `
                <div class="signal-card ${signal}">
                    <div class="signal-header">
                        <div class="signal-title">${signalEmoji[signal]} Trading Signal</div>
                        <div class="signal-badge ${signal}">${signalText[signal]}</div>
                    </div>
                    <div class="signal-details">
                        <strong>Analysis:</strong><br>
                        ${reasons.map(r => `‚Ä¢ ${r}`).join('<br>')}
                    </div>
                    <div style="margin-top: 10px;">
                        <div class="signal-metric">
                            <span class="metric-label">Total HDD (10 days)</span>
                            <span class="metric-value">${totals.totalHDD.toFixed(0)}</span>
                        </div>
                        <div class="signal-metric">
                            <span class="metric-label">Total CDD (10 days)</span>
                            <span class="metric-value">${totals.totalCDD.toFixed(0)}</span>
                        </div>
                        <div class="signal-metric">
                            <span class="metric-label">Signal Strength</span>
                            <span class="metric-value ${strength > 0 ? 'positive' : strength < 0 ? 'negative' : ''}">${strength > 0 ? '+' : ''}${strength}</span>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('tradingSignal').innerHTML = html;
        }
        
        function displayComparison(current, previous) {
            if (!previous) {
                document.getElementById('comparisonCard').innerHTML = `
                    <div class="comparison-card">
                        <div class="comparison-header">üìä Comparison with Previous</div>
                        <p style="text-align: center; color: #999; padding: 20px;">
                            No previous data. Update again later to see changes.
                        </p>
                    </div>
                `;
                return;
            }
            
            const hddChange = current.totalHDD - previous.totalHDD;
            const cddChange = current.totalCDD - previous.totalCDD;
            const tempChange = current.avgTemp - previous.avgTemp;
            
            const timeDiff = new Date() - new Date(previous.timestamp);
            const hoursDiff = Math.floor(timeDiff / (1000 * 60 * 60));
            
            const html = `
                <div class="comparison-card">
                    <div class="comparison-header">üìä Change from Previous Update</div>
                    <p style="font-size: 11px; color: #666; margin-bottom: 10px;">
                        Previous update: ${hoursDiff < 24 ? hoursDiff + ' hours ago' : Math.floor(hoursDiff/24) + ' days ago'}
                    </p>
                    <div class="comparison-row">
                        <span>HDD Forecast</span>
                        <span class="comparison-change ${hddChange > 0 ? 'up' : 'down'}">
                            ${hddChange > 0 ? '‚Üë' : '‚Üì'} ${Math.abs(hddChange).toFixed(0)} 
                            (${((hddChange / previous.totalHDD) * 100).toFixed(1)}%)
                        </span>
                    </div>
                    <div class="comparison-row">
                        <span>CDD Forecast</span>
                        <span class="comparison-change ${cddChange > 0 ? 'up' : 'down'}">
                            ${cddChange > 0 ? '‚Üë' : '‚Üì'} ${Math.abs(cddChange).toFixed(0)}
                            (${previous.totalCDD > 0 ? ((cddChange / previous.totalCDD) * 100).toFixed(1) : 'N/A'}%)
                        </span>
                    </div>
                    <div class="comparison-row">
                        <span>Avg Temperature</span>
                        <span class="comparison-change ${tempChange > 0 ? 'up' : 'down'}">
                            ${tempChange > 0 ? '‚Üë' : '‚Üì'} ${Math.abs(tempChange).toFixed(1)}¬∞F
                        </span>
                    </div>
                    <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #e0e0e0; font-size: 12px; color: #666;">
                        <strong>Impact:</strong> ${hddChange > 30 ? '‚ö†Ô∏è Significant increase in heating demand expected' : 
                                                    hddChange < -30 ? '‚¨áÔ∏è Heating demand declining' :
                                                    cddChange > 20 ? '‚ö†Ô∏è Cooling demand increasing' :
                                                    '‚û°Ô∏è Stable demand forecast'}
                    </div>
                </div>
            `;
            
            document.getElementById('comparisonCard').innerHTML = html;
        }
        
        async function fetchData() {
            const cityName = document.getElementById('city').value;
            const statusEl = document.getElementById('status');
            statusEl.textContent = '‚è≥ Fetching weather data...';
            statusEl.className = 'status loading';
            
            try {
                let newData;
                if (cityName === 'All') {
                    newData = {};
                    for (const [name, coords] of Object.entries(cities)) {
                        newData[name] = await fetchCityData(coords);
                    }
                } else {
                    newData = {[cityName]: await fetchCityData(cities[cityName])};
                }
                
                // Calculate totals
                const totals = calculateTotals(newData);
                
                // Generate trading signal
                const analysis = determineTradingSignal(totals, previousData?.totals);
                displayTradingSignal(analysis);
                
                // Display comparison
                displayComparison(totals, previousData?.totals);
                
                // Save current as previous for next time
                savePreviousData(newData);
                
                // Display data
                currentData = newData;
                displayData(newData);
                
                // Update last update time
                const now = new Date();
                document.getElementById('lastUpdate').textContent = 
                    `Last update: ${now.toLocaleDateString()} ${now.toLocaleTimeString()}`;
                
                // Update totals
                document.getElementById('totalHDD').textContent = totals.totalHDD.toFixed(0);
                
                statusEl.textContent = '‚úÖ Data updated successfully';
                statusEl.className = 'status';
            } catch (error) {
                statusEl.textContent = '‚ùå Error: ' + error.message;
                statusEl.className = 'status loading';
                console.error('Fetch error:', error);
            }
        }
        
        async function fetchCityData(coords) {
            const [lat, lon] = coords;
            const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&daily=temperature_2m_max,temperature_2m_min,weathercode&timezone=America/New_York&forecast_days=10&temperature_unit=fahrenheit`;
            const response = await fetch(url);
            if (!response.ok) throw new Error('API request failed');
            const data = await response.json();
            return data.daily;
        }
        
        function displayData(allData) {
            const cityName = document.getElementById('city').value;
            
            if (cityName === 'All') {
                displayAllCities(allData);
            } else {
                displaySingleCity(Object.keys(allData)[0], Object.values(allData)[0]);
            }
        }
        
        function displayAllCities(allData) {
            let totalCDD = 0;
            let html = '';
            
            for (const [cityName, daily] of Object.entries(allData)) {
                const minF = daily.temperature_2m_min[0];
                const maxF = daily.temperature_2m_max[0];
                
                let cityHDD = 0, cityCDD = 0;
                for (let i = 0; i < 10; i++) {
                    const avg = (daily.temperature_2m_min[i] + daily.temperature_2m_max[i]) / 2;
                    cityHDD += calculateHDD(avg);
                    cityCDD += calculateCDD(avg);
                }
                
                totalCDD += cityCDD;
                
                const minDisplay = convertTemp(minF);
                const maxDisplay = convertTemp(maxF);
                
                html += `
                    <div class="forecast-card">
                        <div class="city-name">${cityName}</div>
                        <div class="temp-display">${minDisplay.toFixed(1)}¬∞ - ${maxDisplay.toFixed(1)}¬∞${tempUnit}</div>
                        <div style="font-size: 12px; color: #666; margin-top: 3px;">
                            ${weatherCodes[daily.weathercode[0]] || 'Unknown'}
                        </div>
                        <div class="hdd-cdd-inline">
                            <div class="hdd-inline">‚ùÑÔ∏è HDD: ${cityHDD.toFixed(0)}</div>
                            <div class="cdd-inline">üî• CDD: ${cityCDD.toFixed(0)}</div>
                        </div>
                    </div>
                `;
            }
            
            document.getElementById('forecastContent').innerHTML = html;
        }
        
        function displaySingleCity(cityName, daily) {
            let totalHDD = 0, totalCDD = 0;
            let html = '';
            
            for (let i = 0; i < 10; i++) {
                const minF = daily.temperature_2m_min[i];
                const maxF = daily.temperature_2m_max[i];
                const avgF = (minF + maxF) / 2;
                
                const hdd = calculateHDD(avgF);
                const cdd = calculateCDD(avgF);
                
                totalHDD += hdd;
                totalCDD += cdd;
                
                const minDisplay = convertTemp(minF);
                const maxDisplay = convertTemp(maxF);
                
                html += `
                    <div class="forecast-card">
                        <div class="city-name">üìÖ ${daily.time[i]}</div>
                        <div class="temp-display">${minDisplay.toFixed(1)}¬∞ - ${maxDisplay.toFixed(1)}¬∞${tempUnit}</div>
                        <div style="font-size: 12px; color: #666;">${weatherCodes[daily.weathercode[i]] || 'Unknown'}</div>
                        <div class="hdd-cdd-inline">
                            <div class="hdd-inline">‚ùÑÔ∏è ${hdd.toFixed(1)}</div>
                            <div class="cdd-inline">üî• ${cdd.toFixed(1)}</div>
                        </div>
                    </div>
                `;
            }
            
            document.getElementById('forecastContent').innerHTML = html;
        }
        
        // Load previous data on startup
        loadPreviousData();
        
        console.log('NATGAS Pro Tracker loaded successfully');
    </script>
</body>
</html>
