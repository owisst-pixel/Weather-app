<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#1e3a8a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="NATGAS Weather">
    <link rel="manifest" href="manifest.json">
    <title>NATGAS Weather Tracker</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%);
            min-height: 100vh;
        }
        
        .app {
            max-width: 100%;
            min-height: 100vh;
            background: white;
        }
        
        .header {
            background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%);
            color: white;
            padding: max(20px, env(safe-area-inset-top)) 20px 20px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .header h1 {
            font-size: 22px;
            margin-bottom: 5px;
        }
        
        .header .subtitle {
            font-size: 13px;
            opacity: 0.9;
        }
        
        .controls {
            padding: 20px;
            background: #f8f9fa;
        }
        
        select, button {
            width: 100%;
            padding: 14px;
            margin-bottom: 10px;
            border: 2px solid #ddd;
            border-radius: 12px;
            font-size: 16px;
            background: white;
        }
        
        button {
            border: none;
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.1s;
        }
        
        button:active {
            transform: scale(0.98);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%);
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, #f59e0b 0%, #ef4444 100%);
        }
        
        .status {
            padding: 12px 20px;
            text-align: center;
            font-weight: 600;
            font-size: 14px;
        }
        
        .status.success {
            background: #e8f5e9;
            color: #2e7d32;
        }
        
        .status.loading {
            background: #fff3e0;
            color: #e65100;
        }
        
        .output {
            padding: 20px;
            padding-bottom: max(20px, env(safe-area-inset-bottom));
        }
        
        .forecast-card {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 12px;
            border-left: 4px solid #3b82f6;
        }
        
        .forecast-date {
            font-weight: 700;
            color: #333;
            margin-bottom: 8px;
            font-size: 16px;
        }
        
        .forecast-temp {
            font-size: 20px;
            font-weight: 700;
            color: #3b82f6;
            margin-bottom: 8px;
        }
        
        .hdd-cdd {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #e0e0e0;
        }
        
        .degree-day {
            text-align: center;
            padding: 8px;
            border-radius: 8px;
            font-size: 13px;
        }
        
        .hdd-box {
            background: #dbeafe;
            color: #1e40af;
        }
        
        .cdd-box {
            background: #fee2e2;
            color: #991b1b;
        }
        
        .degree-day-value {
            font-size: 20px;
            font-weight: 700;
            margin-top: 4px;
        }
        
        .summary-card {
            background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%);
            color: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .summary-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 15px;
        }
        
        .summary-item {
            text-align: center;
            background: rgba(255,255,255,0.1);
            padding: 12px;
            border-radius: 8px;
        }
        
        .summary-label {
            font-size: 12px;
            opacity: 0.9;
            margin-bottom: 5px;
        }
        
        .summary-value {
            font-size: 24px;
            font-weight: 700;
        }
        
        .description {
            color: #666;
            font-size: 14px;
            margin-top: 5px;
        }
        
        .empty {
            text-align: center;
            color: #999;
            padding: 40px 20px;
        }
        
        .city-info {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
            font-style: italic;
        }
    </style>
</head>
<body>
    <div class="app">
        <div class="header">
            <h1>üî• NATGAS Weather Tracker</h1>
            <p class="subtitle">Heating & Cooling Degree Days ‚Ä¢ Top 5 US Markets</p>
        </div>
        
        <div class="controls">
            <select id="city">
                <option value="Houston">Houston, TX (Henry Hub)</option>
                <option value="New York">New York, NY (Demand Center)</option>
                <option value="Chicago">Chicago, IL (Midwest Hub)</option>
                <option value="Boston">Boston, MA (New England)</option>
                <option value="Los Angeles">Los Angeles, CA (West Coast)</option>
            </select>
            
            <button class="btn-primary" onclick="getForecast()">üîÑ Get Forecast & HDD/CDD</button>
            <button class="btn-secondary" onclick="showChanges()">üìä View History</button>
        </div>
        
        <div id="status" class="status success">Ready to track</div>
        
        <div id="output" class="output">
            <div class="empty">
                Select a city and click "Get Forecast"<br>
                <small style="margin-top: 10px; display: block;">
                HDD = Heating Degree Days (65¬∞F base)<br>
                CDD = Cooling Degree Days (65¬∞F base)
                </small>
            </div>
        </div>
    </div>

    <script>
        // Top 5 US cities for NATGAS markets
        const cities = {
            "Houston": {
                coords: [29.7604, -95.3698],
                info: "Henry Hub - Primary pricing point",
                region: "Gulf Coast"
            },
            "New York": {
                coords: [40.7128, -74.0060],
                info: "Major demand center - Northeast",
                region: "Northeast"
            },
            "Chicago": {
                coords: [41.8781, -87.6298],
                info: "Midwest distribution hub",
                region: "Midwest"
            },
            "Boston": {
                coords: [42.3601, -71.0589],
                info: "New England market - High winter demand",
                region: "New England"
            },
            "Los Angeles": {
                coords: [34.0522, -118.2437],
                info: "West Coast - Power generation",
                region: "West Coast"
            }
        };
        
        const weatherCodes = {
            0: "Clear", 1: "Mostly Clear", 2: "Partly Cloudy", 3: "Cloudy",
            45: "Fog", 48: "Rime Fog",
            51: "Light Drizzle", 53: "Drizzle", 55: "Heavy Drizzle",
            61: "Light Rain", 63: "Rain", 65: "Heavy Rain",
            71: "Light Snow", 73: "Snow", 75: "Heavy Snow",
            77: "Snow Grains", 80: "Light Showers", 81: "Showers", 82: "Heavy Showers",
            85: "Light Snow Showers", 86: "Snow Showers",
            95: "Thunderstorm", 96: "Thunderstorm with Hail"
        };
        
        // Calculate HDD (Heating Degree Days) - base 65¬∞F
        function calculateHDD(avgTemp) {
            const base = 65;
            const hdd = Math.max(0, base - avgTemp);
            return hdd;
        }
        
        // Calculate CDD (Cooling Degree Days) - base 65¬∞F
        function calculateCDD(avgTemp) {
            const base = 65;
            const cdd = Math.max(0, avgTemp - base);
            return cdd;
        }
        
        // Convert Celsius to Fahrenheit
        function toFahrenheit(celsius) {
            return (celsius * 9/5) + 32;
        }
        
        function updateStatus(text, type = 'success') {
            const status = document.getElementById('status');
            status.textContent = text;
            status.className = 'status ' + type;
        }
        
        function saveForecasts(city, forecasts) {
            const key = `forecasts_${city}_${new Date().toISOString().split('T')[0]}`;
            const existing = JSON.parse(localStorage.getItem('allForecasts') || '{}');
            existing[key] = forecasts;
            localStorage.setItem('allForecasts', JSON.stringify(existing));
        }
        
        function getAllForecasts(city) {
            const all = JSON.parse(localStorage.getItem('allForecasts') || '{}');
            return Object.entries(all)
                .filter(([key]) => key.startsWith(`forecasts_${city}`))
                .map(([key, value]) => ({
                    date: key.split('_')[2],
                    forecasts: value
                }));
        }
        
        async function getForecast() {
            const cityName = document.getElementById('city').value;
            const city = cities[cityName];
            const [lat, lon] = city.coords;
            const output = document.getElementById('output');
            
            updateStatus('Fetching weather data...', 'loading');
            
            try {
                const response = await fetch(
                    `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&daily=temperature_2m_max,temperature_2m_min,weathercode&timezone=America/New_York&forecast_days=10&temperature_unit=fahrenheit`
                );
                const data = await response.json();
                const daily = data.daily;
                
                const forecasts = [];
                let totalHDD = 0;
                let totalCDD = 0;
                
                let html = `
                    <div class="summary-card">
                        <h2 style="margin-bottom: 5px;">${cityName}</h2>
                        <div class="city-info">${city.info} ‚Ä¢ ${city.region}</div>
                        <div class="summary-grid" id="summaryGrid">
                            <div class="summary-item">
                                <div class="summary-label">Loading...</div>
                            </div>
                        </div>
                    </div>
                `;
                
                html += '<div style="margin-bottom: 15px; font-weight: 600; color: #1e3a8a;">üìÖ 10-Day Forecast</div>';
                
                for (let i = 0; i < 10; i++) {
                    const minF = daily.temperature_2m_min[i];
                    const maxF = daily.temperature_2m_max[i];
                    const avgF = (minF + maxF) / 2;
                    
                    const hdd = calculateHDD(avgF);
                    const cdd = calculateCDD(avgF);
                    
                    totalHDD += hdd;
                    totalCDD += cdd;
                    
                    const forecast = {
                        date: daily.time[i],
                        min: minF,
                        max: maxF,
                        avg: avgF,
                        hdd: hdd,
                        cdd: cdd,
                        desc: weatherCodes[daily.weathercode[i]] || 'Unknown'
                    };
                    forecasts.push(forecast);
                    
                    html += `
                        <div class="forecast-card">
                            <div class="forecast-date">üìÖ ${forecast.date}</div>
                            <div class="forecast-temp">${minF.toFixed(1)}¬∞F - ${maxF.toFixed(1)}¬∞F</div>
                            <div class="description">Avg: ${avgF.toFixed(1)}¬∞F ‚Ä¢ ${forecast.desc}</div>
                            <div class="hdd-cdd">
                                <div class="degree-day hdd-box">
                                    <div>‚ùÑÔ∏è HDD</div>
                                    <div class="degree-day-value">${hdd.toFixed(1)}</div>
                                </div>
                                <div class="degree-day cdd-box">
                                    <div>üî• CDD</div>
                                    <div class="degree-day-value">${cdd.toFixed(1)}</div>
                                </div>
                            </div>
                        </div>
                    `;
                }
                
                output.innerHTML = html;
                
                // Update summary
                document.getElementById('summaryGrid').innerHTML = `
                    <div class="summary-item">
                        <div class="summary-label">Total HDD</div>
                        <div class="summary-value">${totalHDD.toFixed(0)}</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-label">Total CDD</div>
                        <div class="summary-value">${totalCDD.toFixed(0)}</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-label">Avg HDD/Day</div>
                        <div class="summary-value">${(totalHDD/10).toFixed(1)}</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-label">Avg CDD/Day</div>
                        <div class="summary-value">${(totalCDD/10).toFixed(1)}</div>
                    </div>
                `;
                
                saveForecasts(cityName, forecasts);
                updateStatus(`‚úÖ Forecast updated ‚Ä¢ Total HDD: ${totalHDD.toFixed(0)} ‚Ä¢ CDD: ${totalCDD.toFixed(0)}`, 'success');
                
            } catch (error) {
                output.innerHTML = `<div class="empty">‚ùå Error: ${error.message}</div>`;
                updateStatus('Error fetching data', 'error');
            }
        }
        
        function showChanges() {
            const cityName = document.getElementById('city').value;
            const output = document.getElementById('output');
            const allForecasts = getAllForecasts(cityName);
            
            if (allForecasts.length === 0) {
                output.innerHTML = '<div class="empty">‚ö†Ô∏è No saved forecasts. Fetch a forecast first!</div>';
                updateStatus('No data available', 'loading');
                return;
            }
            
            let html = `
                <div class="summary-card">
                    <h2>${cityName} - Forecast History</h2>
                    <p style="margin-top: 5px; font-size: 14px;">Compare HDD/CDD changes over time</p>
                </div>
            `;
            
            allForecasts.forEach(({date, forecasts}) => {
                const totalHDD = forecasts.reduce((sum, f) => sum + f.hdd, 0);
                const totalCDD = forecasts.reduce((sum, f) => sum + f.cdd, 0);
                
                html += `
                    <div style="background: #e3f2fd; padding: 15px; border-radius: 12px; margin-bottom: 15px;">
                        <h3 style="margin-bottom: 10px; color: #1e3a8a;">üìÖ Forecast from ${date}</h3>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px;">
                            <div style="background: white; padding: 10px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 12px; color: #666;">Total HDD</div>
                                <div style="font-size: 20px; font-weight: 700; color: #1e40af;">${totalHDD.toFixed(0)}</div>
                            </div>
                            <div style="background: white; padding: 10px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 12px; color: #666;">Total CDD</div>
                                <div style="font-size: 20px; font-weight: 700; color: #991b1b;">${totalCDD.toFixed(0)}</div>
                            </div>
                        </div>
                `;
                
                forecasts.slice(0, 5).forEach(f => {
                    html += `
                        <div style="background: white; padding: 10px; border-radius: 8px; margin-bottom: 8px; font-size: 13px;">
                            <strong>${f.date}</strong>: ${f.min.toFixed(1)}¬∞F-${f.max.toFixed(1)}¬∞F ‚Ä¢ 
                            HDD: ${f.hdd.toFixed(1)} ‚Ä¢ CDD: ${f.cdd.toFixed(1)}
                        </div>
                    `;
                });
                
                html += `</div>`;
            });
            
            output.innerHTML = html;
            updateStatus('History displayed', 'success');
        }
        
        // Service Worker
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js');
        }
    </script>
</body>
</html>
